# Source files. mod_auth_mellon.c must be the first file.
SRC=src/ngx_http_json.c \
	src/ngx_http_pool.c \
	src/ngx_http_redirectionio_module.c \
	src/ngx_http_redirectionio_module_filter.c \
	src/ngx_http_redirectionio_module_pool.c \
	src/ngx_http_redirectionio_protocol.c

PATCH_FILES:=@PATCH_FILES@

DESTDIR ?=

all: nginx-@NGINX_VERSION@/objs/ngx_http_redirectionio_module.so

nginx-@NGINX_VERSION@.tar.gz:
	wget http://nginx.org/download/nginx-@NGINX_VERSION@.tar.gz -O nginx-@NGINX_VERSION@.tar.gz

nginx-@NGINX_VERSION@: nginx-@NGINX_VERSION@.tar.gz
	tar -xvzf nginx-@NGINX_VERSION@.tar.gz

.PHONY: patch
patch: $(PATCH_FILES)

$(PATCH_FILES): %: nginx-@NGINX_VERSION@
	cd nginx-@NGINX_VERSION@; patch -p1 < ../$*

nginx-@NGINX_VERSION@/objs/ngx_http_redirectionio_module.so: patch nginx-@NGINX_VERSION@
	cd nginx-@NGINX_VERSION@; \
	./configure @NGINX_CONFIGURE@ --add-dynamic-module=../; \
	make modules

.PHONY:	install
install: nginx-@NGINX_VERSION@/objs/ngx_http_redirectionio_module.so
	install -c -m 644 nginx-@NGINX_VERSION@/objs/ngx_http_redirectionio_module.so $(DESTDIR)@MODULE_DIR@/ngx_http_redirectionio_module.so

.PHONY:	clean
clean:
	rm -rf nginx-@NGINX_VERSION@
	rm -f nginx-@NGINX_VERSION@.tar.gz
